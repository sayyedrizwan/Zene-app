//
//  ContentView.swift
//  TestWebView
//
//  Created by Rizwan Sayyed on 31/12/24.
//

import SwiftUI
import WebKit
import AVFoundation
import MediaPlayer

func updateNowPlayingInfo(artwork: UIImage) {
    var nowPlayingInfo = [String: Any]()

    nowPlayingInfo[MPMediaItemPropertyTitle] = "My name isss"
    nowPlayingInfo[MPMediaItemPropertyArtist] = "artists iof"
    nowPlayingInfo[MPMediaItemPropertyAlbumTitle] = "MY albums"
    nowPlayingInfo[MPMediaItemPropertyArtwork] = MPMediaItemArtwork(boundsSize: artwork.size) { _ in artwork }

    MPNowPlayingInfoCenter.default().nowPlayingInfo = nowPlayingInfo
}

class WebViewController: UIViewController, WKNavigationDelegate {
    var webView: WKWebView!
    var backgroundTask: UIBackgroundTaskIdentifier = .invalid

    override func viewDidLoad() {
        super.viewDidLoad()

        // Configure the WKWebView
        let webViewConfiguration = WKWebViewConfiguration()
        webViewConfiguration.allowsInlineMediaPlayback = true
        webViewConfiguration.mediaTypesRequiringUserActionForPlayback = []
        webViewConfiguration.userContentController.add(LoggingMessageHandler(), name: "logging")

        webView = WKWebView(frame: view.bounds, configuration: webViewConfiguration)
        webView.navigationDelegate = self
        webView.translatesAutoresizingMaskIntoConstraints = false

        // Add WebView to the view hierarchy
        view.addSubview(webView)

        // Constrain WebView to fill the view
        NSLayoutConstraint.activate([
            webView.topAnchor.constraint(equalTo: view.topAnchor),
            webView.bottomAnchor.constraint(equalTo: view.bottomAnchor),
            webView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            webView.trailingAnchor.constraint(equalTo: view.trailingAnchor)
        ])

        // Load the YouTube video
        loadYouTubeVideo()

        // Start background task
        startBackgroundTask()

    }

    class LoggingMessageHandler: NSObject, WKScriptMessageHandler {
        func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
            print(message.body)
        }
    }

    func fetchAndUpdateMetadata() {

        if let url = URL(string: "https://lh3.googleusercontent.com/mPnnCSQfTd25JRPuOWY-tik-HoBm6BW7lgO5kD5_7eu-QF87dB3KIE46-O_SQne_k7DrXbi-x48Ab4s") {
            URLSession.shared.dataTask(with: url) { data, _, _ in
                if let data = data, let artworkImage = UIImage(data: data) {
                    updateNowPlayingInfo(artwork: artworkImage)
                }
            }.resume()
        }
    }

    private func loadYouTubeVideo() {
        let html = """
                   <!DOCTYPE html>
                   <html>
                     <body>
                       <div id="player"></div>
                       <script>
                         var tag = document.createElement("script");
                         tag.src = "https://www.youtube.com/iframe_api";
                         var firstScriptTag = document.getElementsByTagName("script")[0];
                         firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                         var player;
                         function onYouTubeIframeAPIReady() {
                           player = new YT.Player("player", {
                             height: "390",
                             width: "640",
                             videoId: "M7lc1UVf-VE",
                             playerVars: {
                               playsinline: 1,
                             },
                             events: {
                               onReady: onPlayerReady,
                               onStateChange: onPlayerStateChange,
                             },
                           });
                         }

                         function onPlayerReady(event) {
                           event.target.playVideo();
                         }

                         function onPlayerStateChange(event) {
                           if (event.data == YT.PlayerState.PLAYING) {
                               var iframe = document.getElementById("player");
                               var iframeWindow = (iframe.contentWindow || iframe.contentDocument);
                               iframeWindow.navigator.mediaSession.metadata = new MediaMetadata({
                                 title: "sooooo",
                                 artist: "aq122222",
                                 artwork: [
                                   {
                                     src: `https://lh3.googleusercontent.com/O5Na8BhQvdaKYVsMY-9TnXfWFms96H6lXubsNURvoJ54Ti8LzNsK-UglhXlKh9EZomfokuzPK6N-HAI`,
                                     type: "image/jpeg",
                                   },
                                 ],
                               });

                               iframeWindow.navigator.mediaSession.setActionHandler("previoustrack", (details) => {

                               });

                               iframeWindow.navigator.mediaSession.setActionHandler("nexttrack", (details) => {

                               });

                               console.log(navigator.mediaSession)
                               console.log(iframeWindow.navigator.mediaSession)
                           }
                         }
                       </script>
                     </body>
                   </html>


        """
        webView.loadHTMLString(html, baseURL: URL(string: "https://www.youtube.com"))

        //
        //        Timer.scheduledTimer(withTimeInterval: 3.0, repeats: true) { _ in
        //
        //            let url = URL(string:"http://www.apple.com/euro/ios/ios8/a/generic/images/og.png")
        //            if let data = try? Data(contentsOf: url!) {
        //                if let image: UIImage = UIImage(data: data) {
        //
        //                    let nowPlayingInfoCenter = MPNowPlayingInfoCenter.default()
        //                    var nowPlayingInfo = [String: Any]()
        //
        //                    nowPlayingInfo[MPMediaItemPropertyTitle] = "sbdhbdhdbhd" // Get title from YouTube video
        //
        //                    nowPlayingInfo[MPMediaItemPropertyArtist] = "778dbhdhdbdh" // Get channel name as artist
        //
        //                    nowPlayingInfo[MPMediaItemPropertyArtwork] = MPMediaItemArtwork(image: image) // Set thumbnail image
        //                }
        //            }
        //        }
    }



    private func startBackgroundTask() {
        backgroundTask = UIApplication.shared.beginBackgroundTask {
            UIApplication.shared.endBackgroundTask(self.backgroundTask)
            self.backgroundTask = .invalid
        }
    }

    private func endBackgroundTask() {
        if backgroundTask != .invalid {
            UIApplication.shared.endBackgroundTask(backgroundTask)
            backgroundTask = .invalid
        }
    }

    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        print("disappear onn")
        endBackgroundTask()
    }
}



class AppDelegate: UIResponder, UIApplicationDelegate {
    var window: UIWindow?

    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        configureAudioSession()
        application.beginReceivingRemoteControlEvents()
        // Create the main window
        window = UIWindow(frame: UIScreen.main.bounds)

        // Initialize the WebViewController
        let webViewController = WebViewController()

        // Set it as the root view controller
        window?.rootViewController = webViewController
        window?.makeKeyAndVisible()

        return true
    }

    private func configureAudioSession() {
        do {
            let session = AVAudioSession.sharedInstance()
            try session.setCategory(.playback, mode: .default, options: [])
            try session.setActive(true)
        } catch {
            print("Failed to configure audio session: \(error)")
        }
    }
}

struct ContentView: View {

    var body: some View {
        VStack {
            Image(systemName: "globe")
                .imageScale(.large)
                .foregroundStyle(.tint)

            YouTubeWebViewSS(videoId: "ekr2nIex040")

        }
        .padding()
    }
}

#Preview {
    ContentView()
}



struct YouTubeWebViewSS: UIViewRepresentable {
    let videoId: String // YouTube video ID

    func makeUIView(context: Context) -> WKWebView {
        let configuration = WKWebViewConfiguration()
        configuration.allowsInlineMediaPlayback = true
        configuration.mediaPlaybackRequiresUserAction = false

        let webView = WKWebView(frame: .zero, configuration: configuration)
        webView.navigationDelegate = context.coordinator

        // Load the YouTube video
        let html = """
        <!DOCTYPE html>
        <html>
        <body style="margin:0px;padding:0px;overflow:hidden;">

        </body>
        </html>
        """
        webView.loadHTMLString(html, baseURL: nil)

        return webView
    }

    func updateUIView(_ uiView: WKWebView, context: Context) {
        // No update required for this use case
    }

    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }

    class Coordinator: NSObject, WKNavigationDelegate {
        var parent: YouTubeWebViewSS

        init(_ parent: YouTubeWebViewSS) {
            self.parent = parent
        }

        // Handle navigation actions or errors here if needed
    }
}
