<!DOCTYPE html>
<html lang="en">
    <body>
        <style>
            * {
              margin: 0;
              padding: 0;
              height: 100%;
              background-color: black;
            }

            #remoteVideo {
              position: fixed;
              width: 100%;
              height: 100%;
            }

            #localVideo {
              border-radius: 10px;
              position: fixed;
              top: 10px;
              right: 10px;
              height: 160px;
              width: 120px;
              object-fit: cover;
            }
        </style>

        <video id="remoteVideo" autoplay="true"></video>
        <video id="localVideo" autoplay="true" muted="true"></video>

        <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
        <script>
            const otherID = "<<<OtherEmail>>>";
            const myID = "<<<MyEmail>>>";

            const localVideo = document.getElementById("localVideo");
            localVideo.style.display = 'none';
            const remoteVideo = document.getElementById("remoteVideo");

            var peer = new Peer(myID);
            var localStreamMine;
            var doShowVideoCall = false;
            var useBackCamera = false;

            let lastFrameTime = performance.now();
            let isCameraOff = false;

            async function getLocalStream() {
              try {
                const constraints = { audio: true, video: false };
                const constraintsFullVideo = {
                  audio: true,
                  video: {
                    facingMode: useBackCamera ? "environment" : "user",
                    quality: 10,
                    width: { ideal: 320 },
                    height: { ideal: 240 },
                  },
                };
                localStreamMine = await navigator.mediaDevices.getUserMedia(doShowVideoCall ? constraintsFullVideo : constraints);
                localVideo.srcObject = localStreamMine;

                try {
                  localVideo.play();
                } catch (err) {
                  console.log(err);
                }
                return localStreamMine;
              } catch (error) {
                console.error("Error accessing media devices:", error);
                alert("Error accessing camera/microphone. Please check permissions.");
              }
            }

            async function startCall() {
              const localStream = await getLocalStream();
              if (!localStream) return;

              const call = peer.call(otherID, localStream);

              call.on("error", (err) => console.error("Call error:", err));
              call.on("close", () => console.log("Call ended"));
            }

            peer.on("open", (id) => {
              console.log("My PeerJS ID:", id);
            });

            peer.on("call", async (call) => {
              const localStream = await getLocalStream();
              if (!localStream) return;

              call.answer(localStream);

              call.on("stream", (remoteStream) => {
                Zene.callPicked();
                remoteVideo.srcObject = remoteStream;
                try {
                  remoteVideo.play();
                } catch (err) {
                  console.log(err);
                }
              });

              call.on("error", (err) => console.error("Call error:", err));
              call.on("close", () => console.log("Call ended"));
            });

            peer.on("connection", async (call) => {
              call.on("close", () => console.log("Call ended"));
            });

            startCall();

            function hideLocalVideo() {
              localVideo.style.display = "none";
            }

            function showLocalVideo() {
              localVideo.style.display = "block";
            }

            async function toggleVideo() {
              const videoTrack = localStreamMine.getVideoTracks()[0];
              if (videoTrack && videoTrack.enabled) {
                videoTrack.enabled = false;
                Zene.isVideoEnabled(false);
                localVideo.style.display = 'none';
              } else {
                doShowVideoCall = true;
                startCall();
                Zene.isVideoEnabled(true);
                localVideo.style.display = 'block';
              }
            }
        </script>
    </body>
</html>
