<!DOCTYPE html>
<html lang="en">
    <body>
        <style>
            * {
              margin: 0;
              padding: 0;
              height: 100%;
              background-color: black;
            }

            #remoteVideo {
              position: fixed;
              width: 100%;
              height: 100%;
            }

            #localVideo {
              border-radius: 10px;
              position: fixed;
              top: 10px;
              right: 10px;
              height: 160px;
              width: 120px;
              object-fit: cover;
            }
        </style>

        <video id="remoteVideo" autoplay="true"></video>
        <video id="localVideo" autoplay="true"></video>

        <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
        <script>
            const otherID = "<<<OtherEmail>>>";
            const myID = "<<<MyEmail>>>";
            const isMyCall = true;

            const localVideo = document.getElementById("localVideo");
            const remoteVideo = document.getElementById("remoteVideo");

            var peer = new Peer(myID);

            let call;
            let remoteStream;

            peer.on("open", (id) => {
              console.log("My peer ID is: " + id);
              // You can display this ID or store it.

              if (isMyCall) {
                // Caller (user_1)

                makeCall(otherID);
              } else {
                peer.on("call", async (incomingCall) => {
                  call = incomingCall;

                  try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                    call.answer(stream); // Answer the call with your own stream

                    call.on("stream", (remoteStream) => {
                      remoteVideo.srcObject = remoteStream;
                      remoteVideo.play();
                    });

                    localVideo.srcObject = stream;
                    localVideo.play();
                  } catch (err) {
                    console.error("Failed to get local stream", err);
                  }
                });
              }
            });

            async function makeCall(remotePeerId) {
              try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                call = peer.call(remotePeerId, stream);

                call.on("stream", (remoteStream) => {
                  // Show remote video stream
                  remoteVideo.srcObject = remoteStream;
                  remoteVideo.play();
                });

                localVideo.srcObject = stream;
                localVideo.play();
              } catch (err) {
                console.error("Failed to get local stream", err);
              }
            }

            // var localStreamMine;
            // var doShowVideoCall = false;
            // var useBackCamera = false;

            // let lastFrameTime = performance.now();
            // let isCameraOff = false;

            // async function getLocalStream() {
            //   try {
            //     const constraints = { audio: true, video: false };
            //     const constraintsFullVideo = {
            //       audio: true,
            //       video: {
            //         facingMode: useBackCamera ? "environment" : "user",
            //         quality: 10,
            //         width: { ideal: 320 },
            //         height: { ideal: 240 },
            //       },
            //     };
            //     localStreamMine = await navigator.mediaDevices.getUserMedia(doShowVideoCall ? constraintsFullVideo : constraints);

            //     return localStreamMine;
            //   } catch (error) {
            //     console.error("Error accessing media devices:", error);
            //     alert("Error accessing camera/microphone. Please check permissions.");
            //   }
            // }

            // async function startCall() {
            //   const localStream = await getLocalStream();
            //   if (!localStream) return;

            //   const call = peer.call(otherID, localStream);

            //   call.on("stream", (remoteStream) => {
            //     // Zene.callPicked();
            //     localVideo.srcObject = remoteStream;
            //     try {
            //       localVideo.play();
            //     } catch (err) {
            //       console.log(err);
            //     }
            //   });

            //   call.on("error", (err) => console.error("Call error:", err));
            //   call.on("close", () => console.log("Call ended"));
            // }

            // peer.on("open", (id) => {
            //   console.log("My PeerJS ID:", id);
            // });

            // peer.on("call", async (call) => {
            //   const localStream = await getLocalStream();
            //   if (!localStream) return;

            //   call.answer(localStream);

            //   call.on("stream", (remoteStream) => {
            //     Zene.callPicked();
            //     remoteVideo.srcObject = remoteStream;
            //     try {
            //       remoteVideo.play();
            //     } catch (err) {
            //       console.log(err);
            //     }
            //   });

            //   call.on("error", (err) => console.error("Call error:", err));
            //   call.on("close", () => console.log("Call ended"));
            // });

            // peer.on("connection", async (call) => {
            //   call.on("close", () => console.log("Call ended"));
            // });

            // startCall();

            // function hideLocalVideo() {
            //   localVideo.style.display = "none";
            // }

            // function showLocalVideo() {
            //   localVideo.style.display = "block";
            // }

            // async function toggleVideo() {
            //   const videoTrack = localStreamMine.getVideoTracks()[0];
            //   if (videoTrack && videoTrack.enabled) {
            //     videoTrack.enabled = false;
            //     Zene.isVideoEnabled(false);
            //     localVideo.style.display = "none";
            //   } else {
            //     doShowVideoCall = true;
            //     startCall();
            //     Zene.isVideoEnabled(true);
            //     localVideo.style.display = "block";
            //   }
            // }

            // function toggleMute() {
            //   if (!localStreamMine) return;

            //   const audioTrack = localStreamMine.getAudioTracks()[0];
            //   if (audioTrack) {
            //     audioTrack.enabled = !audioTrack.enabled;
            //     Zene.isMicEnabled(audioTrack.enabled);
            //   }
            // }
        </script>
    </body>
</html>
